/**
 * @name string-strip-html
 * @fileoverview Strips HTML tags from strings. No parser, accepts mixed sources.
 * @version 9.1.12
 * @author Roy Revelt, Codsen Ltd
 * @license MIT
 * {@link https://codsen.com/os/string-strip-html/}
 */

import w from"lodash.isplainobject";import _ from"lodash.trim";import X from"lodash.without";import{decode as M}from"html-entities";import{rApply as ee}from"ranges-apply";import{Ranges as te}from"ranges-push";import{right as G}from"string-left-right";function x(n){return/[-_A-Za-z0-9]/.test(n)}function P(n,c){if(!n)return[];if(Array.isArray(n))return n.filter(T=>typeof T=="string"&&T.trim());if(typeof n=="string")return n.trim()?[n]:[];throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_03] ${c} must be array containing zero or more strings or something falsey. Currently it's equal to: ${n}, that a type of ${typeof n}.`)}function Q(n,c,T,D){for(let A=c,R=n.length;A<R;A++){if(n.startsWith(T,A))return!0;if(n.startsWith(D,A))return!1}return!1}function F(n,c,T){return!n||!n.quotes||!Q(c,T+1,n.quotes.value,">")}var U="9.1.12";var fe=U,H={ignoreTags:[],ignoreTagsWithTheirContents:[],onlyStripTags:[],stripTogetherWithTheirContents:["script","style","xml"],skipHtmlDecoding:!1,trimOnlySpaces:!1,stripRecognisedHTMLOnly:!1,dumpLinkHrefsNearby:{enabled:!1,putOnNewLine:!1,wrapHeads:"",wrapTails:""},cb:null};function ne(n,c){let T=Date.now(),D=new Set(["!doctype","abbr","address","area","article","aside","audio","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","doctype","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","math","menu","menuitem","meta","meter","nav","noscript","object","ol","optgroup","option","output","param","picture","pre","progress","rb","rp","rt","rtc","ruby","samp","script","section","select","slot","small","source","span","strong","style","sub","summary","sup","svg","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","ul","var","video","wbr","xml"]),A=new Set(["a","b","i","p","q","s","u"]),R=new Set([".",",","?",";",")","\u2026",'"',"\xBB"]),b=[],k=[],p=[],$=[],t={};function Y(){t={attributes:[]}}Y();let y=null,B=null,a={},d={tagName:"",hrefValue:"",openingTagEnds:void 0},O="",C=!1,V=null,L=!0;function z(e){return e!=null}function K(e){return typeof e=="string"}function I(e,r,s){if(Array.isArray(r.stripTogetherWithTheirContents)&&(r.stripTogetherWithTheirContents.includes(t.name)||r.stripTogetherWithTheirContents.includes("*")))if(t.slashPresent&&Array.isArray(b)&&b.some(i=>i.name===t.name)){for(let i=b.length;i--;)if(b[i].name===t.name){$=$.filter(([u,m])=>(u<b[i].lastOpeningBracketAt||u>=e+1)&&(m<=b[i].lastOpeningBracketAt||m>e+1));let o=e+1;t.lastClosingBracketAt&&(o=t.lastClosingBracketAt+1),$.push([b[i].lastOpeningBracketAt,o]),R.has(n[e])&&r.cb?r.cb({tag:t,deleteFrom:b[i].lastOpeningBracketAt,deleteTo:e+1,insert:null,rangesArr:s,proposedReturn:[b[i].lastOpeningBracketAt,e,null]}):r.cb&&r.cb({tag:t,deleteFrom:b[i].lastOpeningBracketAt,deleteTo:e,insert:"",rangesArr:s,proposedReturn:[b[i].lastOpeningBracketAt,e,""]}),b.splice(i,1);break}}else t.slashPresent||b.push(t);else Array.isArray(r.ignoreTagsWithTheirContents)&&j(e,r,t)&&(L=!1)}function N(e,r,s,i,o,u){let m="";if(Number.isInteger(s)&&s<o&&(m+=e.slice(s,o)),Number.isInteger(i)&&i>u+1){let f=e.slice(u+1,i);f.includes(`
`)&&E(i,e)?m+=" ":m+=f}if(!R.has(e[r])&&e[r]!=="!"){let f=m.match(/\n/g);return Array.isArray(f)&&f.length?f.length===1?`
`:f.length===2?`

`:`


`:" "}return""}function J(e){if(e.dumpLinkHrefsNearby.enabled&&d.tagName&&d.tagName===t.name&&t.lastOpeningBracketAt&&(d.openingTagEnds&&t.lastOpeningBracketAt>d.openingTagEnds||!d.openingTagEnds)&&(C=!0),C){let r=e.dumpLinkHrefsNearby.putOnNewLine?`

`:"";O=`${r}${d.hrefValue}${r}`}}function E(e,r){return r?r[e]==="<"&&r[e+1]!=="%":n[e]==="<"&&n[e+1]!=="%"}function S(e){return n[e]===">"&&n[e-1]!=="%"}function j(e,r,s){if(r.ignoreTagsWithTheirContents.includes("*"))return!0;let i=n.indexOf(`<${s.name}`,e),o=n.indexOf(`</${s.name}`,e);return!s.slashPresent&&o===-1||s.slashPresent&&!k.some(u=>u.name===s.name)||o>-1&&i>-1&&i<o?!1:r.ignoreTagsWithTheirContents.includes(s.name)}if(typeof n!="string")throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_01] Input must be string! Currently it's: ${(typeof n).toLowerCase()}, equal to:
${JSON.stringify(n,null,4)}`);if(c&&!w(c))throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_02] Optional Options Object must be a plain object! Currently it's: ${(typeof c).toLowerCase()}, equal to:
${JSON.stringify(c,null,4)}`);function v(){C&&(d={tagName:"",hrefValue:"",openingTagEnds:void 0},C=!1)}let l={...H,...c};if(Object.prototype.hasOwnProperty.call(l,"returnRangesOnly"))throw new TypeError("string-strip-html/stripHtml(): [THROW_ID_03] resolvedOpts.returnRangesOnly has been removed from the API since v.5 release.");l.ignoreTags=P(l.ignoreTags,"resolvedOpts.ignoreTags"),l.onlyStripTags=P(l.onlyStripTags,"resolvedOpts.onlyStripTags");let q=!!l.onlyStripTags.length;if(l.onlyStripTags.length&&l.ignoreTags.length&&(l.onlyStripTags=X(l.onlyStripTags,...l.ignoreTags)),w(l.dumpLinkHrefsNearby)||(l.dumpLinkHrefsNearby={...H.dumpLinkHrefsNearby}),l.dumpLinkHrefsNearby=H.dumpLinkHrefsNearby,c&&Object.prototype.hasOwnProperty.call(c,"dumpLinkHrefsNearby")&&z(c.dumpLinkHrefsNearby)){if(w(c.dumpLinkHrefsNearby))l.dumpLinkHrefsNearby={...H.dumpLinkHrefsNearby,...c.dumpLinkHrefsNearby};else if(c.dumpLinkHrefsNearby)throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_04] Optional Options Object's key dumpLinkHrefsNearby was set to ${typeof c.dumpLinkHrefsNearby}, equal to ${JSON.stringify(c.dumpLinkHrefsNearby,null,4)}. The only allowed value is a plain object. See the API reference.`)}l.stripTogetherWithTheirContents?typeof l.stripTogetherWithTheirContents=="string"&&l.stripTogetherWithTheirContents.length&&(l.stripTogetherWithTheirContents=[l.stripTogetherWithTheirContents]):l.stripTogetherWithTheirContents=[];let W={};if(l.stripTogetherWithTheirContents&&Array.isArray(l.stripTogetherWithTheirContents)&&l.stripTogetherWithTheirContents.length&&!l.stripTogetherWithTheirContents.every((e,r)=>typeof e!="string"?(W.el=e,W.i=r,!1):!0))throw new TypeError(`string-strip-html/stripHtml(): [THROW_ID_05] Optional Options Object's key stripTogetherWithTheirContents was set to contain not just string elements! For example, element at index ${W.i} has a value ${W.el} which is not string but ${(typeof W.el).toLowerCase()}.`);l.cb||(l.cb=({rangesArr:e,proposedReturn:r})=>{r&&e.push(...r)});let g=new te({limitToBeAddedWhitespace:!0,limitLinebreaksCount:2});if(!l.skipHtmlDecoding)for(;n!==M(n,{scope:"strict"});)n=M(n,{scope:"strict"});for(let e=0,r=n.length;e<r;e++){if(Object.keys(t).length>1&&t.lastClosingBracketAt&&t.lastClosingBracketAt<e&&n[e]!==" "&&V===null&&(V=e),n[e]==="%"&&n[e-1]==="{"&&n.includes("%}",e+1)){e=n.indexOf("%}",e)-1;continue}if(S(e)&&(!t||Object.keys(t).length<2)&&e>1){for(let s=e;s--;)if(n[s-1]===void 0||S(s)){let i=n[s-1]===void 0?s:s+1,o=n.slice(i,e+1);if(n!==`<${_(o.trim(),"/>")}>`&&[...D].some(u=>_(o.trim().split(/\s+/).filter(m=>m.trim()).filter((m,f)=>f===0),"/>").toLowerCase()===u)&&ne(`<${o.trim()}>`,l).result===""){(!p.length||p[p.length-1][0]!==t.lastOpeningBracketAt)&&p.push([i,e+1]),(!$.length||$[$.length-1][0]!==t.lastOpeningBracketAt)&&$.push([i,e+1]);let u=N(n,e,i,e+1,i,e+1),m=e+1;if(n[m]&&!n[m].trim()){for(let f=m;f<r;f++)if(n[f].trim()){m=f;break}}l.cb({tag:t,deleteFrom:i,deleteTo:m,insert:u,rangesArr:g,proposedReturn:[i,m,u]})}break}}if(n[e]==="/"&&!t.quotes?.value&&Number.isInteger(t.lastOpeningBracketAt)&&!Number.isInteger(t.lastClosingBracketAt)&&(t.slashPresent=e),n[e]==='"'||n[e]==="'")if(t.nameStarts&&t.quotes&&t.quotes.value&&t.quotes.value===n[e]){a.valueEnds=e,a.value=n.slice(a.valueStarts,e),t.attributes.push(a),a={},t.quotes=void 0;let s;l.dumpLinkHrefsNearby.enabled&&t.attributes.some(i=>{if(i.name&&i.name.toLowerCase()==="href")return s=`${l.dumpLinkHrefsNearby.wrapHeads||""}${i.value}${l.dumpLinkHrefsNearby.wrapTails||""}`,!0})&&(d={tagName:t.name,hrefValue:s,openingTagEnds:void 0})}else!t.quotes&&t.nameStarts&&(t.quotes={},t.quotes.value=n[e],t.quotes.start=e,a.nameStarts&&a.nameEnds&&a.nameEnds<e&&a.nameStarts<e&&!a.valueStarts&&(a.name=n.slice(a.nameStarts,a.nameEnds)));if(t.nameStarts!==void 0&&t.nameEnds===void 0&&(!n[e].trim()||!x(n[e]))){if(t.nameEnds=e,t.name=n.slice(t.nameStarts,t.nameEnds+(!S(e)&&n[e]!=="/"&&n[e+1]===void 0?1:0)),n[t.nameStarts-1]!=="!"&&!t.name.replace(/-/g,"").length||/^\d+$/.test(t.name[0])){t={};continue}if(E(e)){J(l);let s=N(n,e,t.leftOuterWhitespace,e,t.lastOpeningBracketAt,e);(l.stripTogetherWithTheirContents.includes(t.name)||l.stripTogetherWithTheirContents.includes("*"))&&($=$.filter(([i,o])=>!(i===t.leftOuterWhitespace&&o===e))),l.cb({tag:t,deleteFrom:t.leftOuterWhitespace,deleteTo:e,insert:`${s}${O}${s}`,rangesArr:g,proposedReturn:[t.leftOuterWhitespace,e,`${s}${O}${s}`]}),v(),I(e,l,g)}}if(t.quotes?.start&&t.quotes.start<e&&!t.quotes.end&&a.nameEnds&&a.equalsAt&&!a.valueStarts&&(a.valueStarts=e),!t.quotes&&a.nameEnds&&n[e]==="="&&!a.valueStarts&&!a.equalsAt&&(a.equalsAt=e),!t.quotes&&a.nameStarts&&a.nameEnds&&!a.valueStarts&&n[e].trim()&&n[e]!=="="&&(t.attributes.push(a),a={}),!t.quotes&&a.nameStarts&&!a.nameEnds&&(n[e].trim()?n[e]==="="?a.equalsAt||(a.nameEnds=e,a.equalsAt=e,a.name=n.slice(a.nameStarts,a.nameEnds)):n[e]==="/"||S(e)?(a.nameEnds=e,a.name=n.slice(a.nameStarts,a.nameEnds),t.attributes.push(a),a={}):E(e)&&(a.nameEnds=e,a.name=n.slice(a.nameStarts,a.nameEnds),t.attributes.push(a),a={}):(a.nameEnds=e,a.name=n.slice(a.nameStarts,a.nameEnds))),!t.quotes&&t.nameEnds<e&&!n[e-1].trim()&&n[e].trim()&&!"<>/!".includes(n[e])&&!a.nameStarts&&!t.lastClosingBracketAt&&(a.nameStarts=e),t.lastOpeningBracketAt!==null&&t.lastOpeningBracketAt<e&&n[e]==="/"&&t.onlyPlausible&&(t.onlyPlausible=!1),t.lastOpeningBracketAt!==null&&t.lastOpeningBracketAt<e&&n[e]!=="/"&&(t.onlyPlausible===void 0&&((!n[e].trim()||E(e))&&!t.slashPresent?t.onlyPlausible=!0:t.onlyPlausible=!1),n[e].trim()&&t.nameStarts===void 0&&!E(e)&&n[e]!=="/"&&!S(e)&&n[e]!=="!"&&(t.nameStarts=e,t.nameContainsLetters=!1)),t.nameStarts&&!t.quotes&&n[e].toLowerCase()!==n[e].toUpperCase()&&(t.nameContainsLetters=!0),S(e)&&F(t,n,e)&&!0&&t.lastOpeningBracketAt!==void 0&&(t.lastClosingBracketAt=e,V=null,Object.keys(a).length&&(t.attributes.push(a),a={}),l.dumpLinkHrefsNearby.enabled&&d.tagName&&!d.openingTagEnds&&(d.openingTagEnds=e)),t.lastOpeningBracketAt!==void 0){if(t.lastClosingBracketAt===void 0){if(t.lastOpeningBracketAt<e&&!E(e)&&(n[e+1]===void 0||E(e+1))&&t.nameContainsLetters){if(t.name=n.slice(t.nameStarts,t.nameEnds?t.nameEnds:e+1).toLowerCase(),(!p.length||p[p.length-1][0]!==t.lastOpeningBracketAt)&&p.push([t.lastOpeningBracketAt,e+1]),l.ignoreTags.includes(t.name)||j(e,l,t)||!D.has(t.name)&&(t.onlyPlausible||l.stripRecognisedHTMLOnly)){t={},a={};continue}if((D.has(t.name)||A.has(t.name))&&(t.onlyPlausible===!1||t.onlyPlausible===!0&&t.attributes.length)||n[e+1]===void 0){J(l);let s=N(n,e,t.leftOuterWhitespace,e+1,t.lastOpeningBracketAt,t.lastClosingBracketAt);l.cb({tag:t,deleteFrom:t.leftOuterWhitespace,deleteTo:e+1,insert:`${s}${O}${s}`,rangesArr:g,proposedReturn:[t.leftOuterWhitespace,e+1,`${s}${O}${s}`]}),v(),I(e,l,g)}if(!$.length||$[$.length-1][0]!==t.lastOpeningBracketAt&&$[$.length-1][1]!==e+1)if(l.stripTogetherWithTheirContents.includes(t.name)||l.stripTogetherWithTheirContents.includes("*")){let s;for(let i=b.length;i--;)b[i].name===t.name&&(s=b[i]);s?($=$.filter(([i])=>i!==s.lastOpeningBracketAt),$.push([s.lastOpeningBracketAt,e+1])):$.push([t.lastOpeningBracketAt,e+1])}else $.push([t.lastOpeningBracketAt,e+1])}}else if(e>t.lastClosingBracketAt&&n[e].trim()||n[e+1]===void 0){let s=t.lastClosingBracketAt===e?e+1:e;l.trimOnlySpaces&&s===r-1&&V!==null&&V<e&&(s=V),(!p.length||p[p.length-1][0]!==t.lastOpeningBracketAt)&&p.push([t.lastOpeningBracketAt,t.lastClosingBracketAt+1]);let i=l.ignoreTags.includes(t.name),o=j(e,l,t);if(!L||l.stripRecognisedHTMLOnly&&!D.has(t.name.toLowerCase())||!q&&(i||o)||q&&!l.onlyStripTags.includes(t.name)){if(o)if(t.slashPresent){for(let u=k.length;u--;)if(k[u].name===t.name){k.splice(u,1);break}k.length||(L=!0)}else L&&(L=!1),k.push(t);l.cb({tag:t,deleteFrom:null,deleteTo:null,insert:null,rangesArr:g,proposedReturn:null}),t={},a={}}else if(!t.onlyPlausible||t.attributes.length===0&&t.name&&(D.has(t.name.toLowerCase())||A.has(t.name.toLowerCase()))||t.attributes?.some(u=>u.equalsAt)){(!$.length||$[$.length-1][0]!==t.lastOpeningBracketAt)&&$.push([t.lastOpeningBracketAt,t.lastClosingBracketAt+1]);let u=N(n,e,t.leftOuterWhitespace,s,t.lastOpeningBracketAt,t.lastClosingBracketAt);O="",C=!1,J(l);let m;K(O)&&O.length?m=`${u}${O}${u===`

`?`
`:u}`:m=u,(t.leftOuterWhitespace===0||!G(n,s-1))&&(m=""),l.cb({tag:t,deleteFrom:t.leftOuterWhitespace,deleteTo:s,insert:m,rangesArr:g,proposedReturn:[t.leftOuterWhitespace,s,m]}),v(),I(e,l,g)}else t={};S(e)||(t={})}}if(E(e)&&!E(e-1)&&!`'"`.includes(n[e+1])&&(!`'"`.includes(n[e+2])||/\w/.test(n[e+1]))&&!(n[e+1]==="c"&&n[e+2]===":")&&!(n[e+1]==="f"&&n[e+2]==="m"&&n[e+3]==="t"&&n[e+4]===":")&&!(n[e+1]==="s"&&n[e+2]==="q"&&n[e+3]==="l"&&n[e+4]===":")&&!(n[e+1]==="x"&&n[e+2]===":")&&!(n[e+1]==="f"&&n[e+2]==="n"&&n[e+3]===":")&&F(t,n,e)){if(S(G(n,e)))continue;if(t.nameEnds&&t.nameEnds<e&&!t.lastClosingBracketAt&&(t.onlyPlausible===!0&&t.attributes&&t.attributes.length||t.onlyPlausible===!1)){let s=N(n,e,t.leftOuterWhitespace,e,t.lastOpeningBracketAt,e);l.cb({tag:t,deleteFrom:t.leftOuterWhitespace,deleteTo:e,insert:s,rangesArr:g,proposedReturn:[t.leftOuterWhitespace,e,s]}),I(e,l,g),t={},a={}}if(t.lastOpeningBracketAt!==void 0&&t.onlyPlausible&&t.name&&!t.quotes&&(t.lastOpeningBracketAt=void 0,t.name=void 0,t.onlyPlausible=!1),(t.lastOpeningBracketAt===void 0||!t.onlyPlausible)&&!t.quotes&&(t.lastOpeningBracketAt=e,t.slashPresent=!1,t.attributes=[],y===null?t.leftOuterWhitespace=e:l.trimOnlySpaces&&y===0?t.leftOuterWhitespace=B||e:t.leftOuterWhitespace=y,`${n[e+1]}${n[e+2]}${n[e+3]}`=="!--"||`${n[e+1]}${n[e+2]}${n[e+3]}${n[e+4]}${n[e+5]}${n[e+6]}${n[e+7]}${n[e+8]}`=="![CDATA[")){let s=!0;n[e+2]==="-"&&(s=!1);let i;for(let o=e;o<r;o++)if((!i&&s&&`${n[o-2]}${n[o-1]}${n[o]}`=="]]>"||!s&&`${n[o-2]}${n[o-1]}${n[o]}`=="-->")&&(i=o),i&&(i<o&&n[o].trim()||n[o+1]===void 0)){let u=o;(n[o+1]===void 0&&!n[o].trim()||n[o]===">")&&(u+=1),(!p.length||p[p.length-1][0]!==t.lastOpeningBracketAt)&&p.push([t.lastOpeningBracketAt,i+1]),(!$.length||$[$.length-1][0]!==t.lastOpeningBracketAt)&&$.push([t.lastOpeningBracketAt,i+1]);let m=N(n,o,t.leftOuterWhitespace,u,t.lastOpeningBracketAt,i);l.cb({tag:t,deleteFrom:t.leftOuterWhitespace,deleteTo:u,insert:m,rangesArr:g,proposedReturn:[t.leftOuterWhitespace,u,m]}),e=o-1,n[o]===">"&&(e=o),t={},a={};break}}}n[e].trim()?y!==null&&(!t.quotes&&a.equalsAt>y-1&&a.nameEnds&&a.equalsAt>a.nameEnds&&n[e]!=='"'&&n[e]!=="'"&&(w(a)&&t.attributes.push(a),a={},t.equalsSpottedAt=void 0),y=null):y===null&&(y=e,t.lastOpeningBracketAt!==void 0&&t.lastOpeningBracketAt<e&&t.nameStarts&&t.nameStarts<t.lastOpeningBracketAt&&e===t.lastOpeningBracketAt+1&&!b.some(s=>s.name===t.name)&&(t.onlyPlausible=!0,t.name=void 0,t.nameStarts=void 0)),n[e]===" "?B===null&&(B=e):B!==null&&(B=null)}if(n&&(l.trimOnlySpaces&&n[0]===" "||!l.trimOnlySpaces&&!n[0].trim()))for(let e=0,r=n.length;e<r;e++)if(l.trimOnlySpaces&&n[e]!==" "||!l.trimOnlySpaces&&n[e].trim()){g.push([0,e]);break}else n[e+1]||g.push([0,e+1]);if(n&&(l.trimOnlySpaces&&n[n.length-1]===" "||!l.trimOnlySpaces&&!n[n.length-1].trim())){for(let e=n.length;e--;)if(l.trimOnlySpaces&&n[e]!==" "||!l.trimOnlySpaces&&n[e].trim()){g.push([e+1,n.length]);break}}let h=g.current();if((!c||!c.cb)&&h){if(h[0]&&!h[0][0]){let e=h[0][1];g.ranges[0]=[g.ranges[0][0],g.ranges[0][1]]}if(h[h.length-1]&&h[h.length-1][1]===n.length){let e=h[h.length-1][0];if(g.ranges){let r=g.ranges[g.ranges.length-1][0];n[r-1]&&(l.trimOnlySpaces&&n[r-1]===" "||!l.trimOnlySpaces&&!n[r-1].trim())&&(r-=1);let s=g.ranges[g.ranges.length-1][2];g.ranges[g.ranges.length-1]=[r,g.ranges[g.ranges.length-1][1]],s?.trim()&&g.ranges[g.ranges.length-1].push(s.trimEnd())}}}return{log:{timeTakenInMilliseconds:Date.now()-T},result:ee(n,g.current()),ranges:g.current(),allTagLocations:p,filteredTagLocations:$}}export{H as defaults,ne as stripHtml,fe as version};
